#include <arch/x86/pmode/context.h>

//Sets up a context for a kernel-level task and returns a pointer
//to the head of the stack (a context_t* type)
context_t *arch_create_kcontext( void (*start)(void *), void *param, void (*exit)(), uint32_t stack_addr ){

        //Pointer to the head of the thread's stack
        uint32_t *thread_stack = stack + stack_size;

        // Give the first parameter to the thread by placing
        // it at the head of the thread stack
        thread_stack--;
        *thread_stack = (uint32_t)param;

        //This is called when the function returns
        thread_stack--;
        *thread_stack = (uint32_t)thread_exit;

        // Add the thread context to the thread stack 
        // This really just allocates space for the registers;
        // the actual values are placed when we do a thread switch
        *context = (void *)thread_stack - sizeof(thread_context_t);

        // Initilize the thread context by setting the function
        // to call and the initial eflags value
        (*context)->eip = (uint32_t)func;
        (*context)->eflags = INITIAL_EFLAGS;
        (*context)->cs = gdt_kernel_code;
        (*context)->ebp = (*context)->esp = 
           (*context)->esp_pushed = (uint32_t)(*context);
        (*context)->ss = (*context)->gs = (*context)->fs = (*context)->es = (*context)->ds = gdt_kernel_data;
}


void arch_create_userland_context(thread_context_t **context, 
   void (*func)(void *), void *param, void (*thread_exit)(), void *stack, uint32_t stack_size ){

        //Pointer to the head of the thread's stack
        uint32_t *thread_stack = stack + stack_size;

        // Give the first parameter to the thread by placing
        // it at the head of the thread stack
        thread_stack--;
        *thread_stack = (uint32_t)param;

        //This is called when the function returns
        thread_stack--;
        *thread_stack = (uint32_t)thread_exit;

        // Add the thread context to the thread stack 
        // This really just allocates space for the registers;
        // the actual values are placed when we do a thread switch
        *context = (void *)thread_stack - sizeof(thread_context_t);

        // Initilize the thread context by setting the function
        // to call and the initial eflags value
        (*context)->eip = (uint32_t)func;
        //See gdt.c/h for what this value is for
        (*context)->cs = 0x1B;
        (*context)->ss  = 0x23;
        (*context)->eflags = INITIAL_EFLAGS;
        (*context)->ebp = (*context)->esp =
        (*context)->esp_pushed = (uint32_t)(*context);
}

